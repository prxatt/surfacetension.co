<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Surface Tension - A multidimensional experiential brand transforming the ordinary into the extraordinary.">
    <meta name="keywords" content="surface tension, experiential brand, immersive experiences, digital art">
    <meta name="author" content="Surface Tension">
    
    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://surfacetension.co/">
    <meta property="og:title" content="Surface Tension">
    <meta property="og:description" content="A multidimensional experiential brand transforming the ordinary into the extraordinary.">
    <meta property="og:image" content="https://surfacetension.co/og-image.jpg">
    
    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:url" content="https://surfacetension.co/">
    <meta property="twitter:title" content="Surface Tension">
    <meta property="twitter:description" content="A multidimensional experiential brand transforming the ordinary into the extraordinary.">
    <meta property="twitter:image" content="https://surfacetension.co/og-image.jpg">
    
    <title>Surface Tension</title>
    
    <!-- FAVICON: Corrected SVG favicon for the brand -->
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Cpath d='M75,20 C50,20 50,40 65,50 C80,60 80,80 50,80 C20,80 20,60 35,50 C50,40 50,20 25,20' stroke='%23FFFFFF' stroke-width='6' fill='none' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E">

    <!-- Preconnect for faster font loading -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://use.typekit.net" crossorigin>
    
    <!-- Fonts -->
    <link rel="stylesheet" href="https://use.typekit.net/jhs3mli.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500&display=swap" rel="stylesheet">

    <!-- Analytics - Vercel Insights (only loads on Vercel) -->
    <script>
        window.va = window.va || function () { (window.va.q = window.va.q || []).push(arguments); };
    </script>
    <script src="/_vercel/insights/script.js" defer></script>

    <style>
        /* --- Base Setup --- */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            height: 100vh;
            width: 100vw;
            overflow: hidden;
            background-color: #000000;
            color: white;
            font-family: 'Inter', sans-serif;
            user-select: none;
            -webkit-user-select: none;
        }
        
        /* --- Skip to Content Link (Accessibility) --- */
        .skip-to-content {
            position: absolute;
            top: -40px;
            left: 0;
            background: #fff;
            color: #000;
            padding: 8px 16px;
            text-decoration: none;
            z-index: 10000;
            font-weight: 500;
        }
        .skip-to-content:focus {
            top: 0;
        }

        /* --- Content Visibility Transitions --- */
        .content-hidden {
            opacity: 0;
        }
        .content-visible {
            opacity: 1;
            transition: opacity 1.5s ease-in;
        }

        /* --- WebGL Canvas Container --- */
        #vfx-canvas-container {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            z-index: 1; 
        }
        
        /* --- Main Title (Centered) --- */
        #text-container {
            position: absolute;
            inset: 0;
            display: flex;
            flex-direction: column; /* Allow subtitle to sit below */
            justify-content: center;
            align-items: center;
            z-index: 3;
            pointer-events: none;
        }
        #main-title {
            font-family: "ivypresto-display", serif;
            font-weight: 300;
            font-style: normal;
            font-size: clamp(3rem, 12vw, 10rem); 
            color: rgba(255, 255, 255, 0.9);
            text-align: center;
            letter-spacing: 0.05em;
            text-shadow: 0 0 50px rgba(0, 0, 0, 0.9);
            transition: opacity 1.5s ease;
        }
        
        /* --- NEW: Subtitle Styling --- */
        #subtitle {
            font-family: 'Inter', sans-serif;
            font-weight: 400;
            font-size: clamp(0.75rem, 1.5vw, 1rem);
            color: rgba(255, 255, 255, 0.6);
            letter-spacing: 0.1em;
            text-transform: uppercase;
            margin-top: 0.5rem;
            transition: opacity 1.5s ease;
        }

        /* --- Top Title (Appears after audio is enabled) --- */
        #top-title-container {
            position: fixed;
            top: 1.5rem;
            left: 50%;
            transform: translateX(-50%);
            z-index: 101;
            pointer-events: none;
        }
        #top-title {
            font-family: "ivypresto-display", serif;
            font-weight: 300;
            font-size: 1.5rem;
            color: rgba(255, 255, 255, 0.8);
            letter-spacing: 0.02em;
            text-shadow: 0 0 10px rgba(0,0,0,0.7);
            opacity: 0;
            transition: opacity 1.5s ease;
        }

        /* --- Logo --- */
        #logo-container {
            position: fixed;
            top: 1.5rem;
            right: 1.5rem;
            z-index: 100;
            width: 48px;
            height: 48px;
            color: rgba(255, 255, 255, 0.7);
            transition: color 0.3s ease, transform 0.4s ease;
        }
        #logo-container:hover {
            color: white;
            transform: scale(1.1);
        }
        #logo-container svg {
            width: 100%;
            height: 100%;
        }
        

        /* --- Main UI (Audio Button & Socials) --- */
        #ui-container {
            position: fixed;
            bottom: 1rem;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1.5rem;
            z-index: 100;
            transition: opacity 0.5s ease-in-out;
        }

        #ui-container.ui-hidden {
            opacity: 0;
            pointer-events: none;
        }


        #social-links-container {
            display: flex;
            gap: 2.5rem;
            align-items: center;
            justify-content: center;
            padding-bottom: 2rem;
            transition: transform 0.5s ease-in-out;
        }

        #ui-container.audio-active #social-links-container {
            transform: scale(0.9);
        }

        #social-links-container a {
            color: rgba(255, 255, 255, 0.4);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            padding: 12px;
            pointer-events: auto;
            will-change: transform;
            outline: none;
        }
        #social-links-container a:focus-visible {
            outline: 2px solid rgba(255, 255, 255, 0.8);
            outline-offset: 4px;
            border-radius: 8px;
        }
        #social-links-container a::before {
            content: '';
            position: absolute;
            inset: -2px;
            border-radius: 8px;
            background: linear-gradient(45deg, rgba(16, 185, 129, 0.1), rgba(168, 85, 247, 0.1), rgba(0, 255, 255, 0.1));
            opacity: 0;
            transform: scale(0.8);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: -1;
        }
        #social-links-container a:hover {
            transform: translateY(-3px) scale(1.08);
        }
        #social-links-container a:hover::before {
            opacity: 1;
            transform: scale(1);
        }
        #social-links-container a:nth-child(1):hover { color: #E4405F; }
        #social-links-container a:nth-child(2):hover { color: #1DA1F2; }
        #social-links-container a:nth-child(3):hover { color: #00f2ea; }
        #social-links-container a:nth-child(4):hover { color: #1877F2; }
        
        #social-links-container svg {
            width: 18px;
            height: 18px;
            stroke-width: 1.5;
            filter: drop-shadow(0 2px 8px rgba(0,0,0,0.4));
        }

        /* --- Footer --- */
        #footer-elements {
            position: fixed;
            bottom: 0.5rem;
            left: 0;
            right: 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 2rem;
            z-index: 99;
            font-family: 'Inter', sans-serif;
            font-size: 0.7rem;
            color: rgba(255, 255, 255, 0.4);
            pointer-events: none;
        }
        
        #contact-link {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: rgba(255, 255, 255, 0.5);
            text-decoration: none;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            pointer-events: auto;
            outline: none;
        }
        #contact-link:focus-visible {
            outline: 2px solid rgba(255, 255, 255, 0.8);
            outline-offset: 4px;
            border-radius: 4px;
        }
        #contact-link:hover {
            color: #10b981;
            transform: translateY(-1px);
        }
        #contact-link svg { width: 14px; height: 14px; }
        #rights-text { text-transform: uppercase; letter-spacing: 0.05em; }

        /* --- Responsive Design --- */
        @media (max-width: 768px) {
            #logo-container { top: 1rem; right: 1rem; width: 32px; height: 32px; }
            #social-links-container { gap: 1.5rem; padding-bottom: 2rem; }
            #footer-elements { flex-direction: column; gap: 0.5rem; padding: 0 1rem; bottom: 0.3rem; }
        }
        
        /* --- Reduced Motion Support --- */
        @media (prefers-reduced-motion: reduce) {
            *,
            *::before,
            *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }
    </style>
</head>
<body>
    <!-- Skip to Content Link (Accessibility) -->
    <a href="#main-title" class="skip-to-content">Skip to main content</a>
    
    <!-- Logo SVG -->
    <div id="logo-container" class="content-hidden" role="img" aria-label="Surface Tension Logo">
        <svg viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" preserveAspectRatio="xMidYMid meet" aria-hidden="true">
            <g transform="translate(0.000000,1024.000000) scale(0.100000,-0.100000)" fill="currentColor" stroke="none">
                <path d="M4560 7955 c261 -24 779 -72 1150 -105 371 -33 685 -63 698 -66 l22 -4 0 -313 0 -312 -131 -120 c-72 -66 -141 -128 -153 -138 -22 -18 -32 -18 -322 2 -164 12 -337 23 -384 26 -141 9 -229 15 -360 25 -69 5 -133 9 -142 10 -17 0 -18 -35 -18 -588 l0 -589 -347 -300 c-192 -164 -383 -330 -426 -368 -43 -37 -79 -66 -81 -64 -3 2 -6 632 -7 1399 -2 767 -6 1416 -9 1442 -4 26 -3 49 2 50 5 2 3 11 -4 20 -12 16 -19 15 -97 -16 -46 -19 -79 -30 -74 -25 12 12 173 77 193 78 8 0 229 -19 490 -44z m624 -1232 c84 -71 210 -175 280 -232 70 -57 124 -106 119 -110 -90 -74 -149 -124 -248 -212 -160 -141 -288 -249 -296 -249 -3 0 -5 12 -2 28 3 23 2 24 -6 7 -9 -19 -10 -19 -10 3 -1 12 4 22 9 22 6 0 10 17 10 38 -1 32 -2 34 -8 12 -8 -27 -22 127 -19 209 l1 46 7 -45 c4 -27 7 22 7 120 0 109 -3 145 -7 105 -4 -40 -7 5 -9 135 -2 107 -5 207 -7 223 -3 20 -1 27 11 27 8 0 84 -57 169 -127z m-167 -355 c-3 -7 -5 -2 -5 12 0 14 2 19 5 13 2 -7 2 -19 0 -25z m0 -70 c-3 -7 -5 -2 -5 12 0 14 2 19 5 13 2 -7 2 -19 0 -25z m1416 -620 c2 -40 3 -660 3 -1378 l-1 -1305 -315 0 c-391 1 -2044 16 -2047 19 -1 1 -3 140 -3 309 -1 169 -4 307 -8 307 -19 -1 -149 -21 -166 -26 -10 -3 -17 -2 -15 3 2 6 90 85 195 176 l192 166 78 18 c92 21 256 23 872 10 330 -7 382 -6 382 7 0 8 -5 16 -11 18 -7 2 -7 12 1 32 9 23 8 27 -4 23 -8 -3 -17 0 -20 8 -3 9 0 12 10 8 12 -4 15 0 13 18 -2 13 0 30 4 37 5 7 3 12 -4 12 -7 0 -4 7 7 15 10 8 13 15 7 15 -9 0 -10 7 -2 27 8 21 16 613 9 673 -1 8 1 43 5 77 11 89 7 94 -55 78 -28 -7 -57 -18 -64 -24 -7 -6 -15 -8 -19 -5 -3 3 -15 1 -26 -6 -43 -23 -18 10 72 91 50 47 202 183 337 304 135 120 260 232 277 248 22 21 72 44 155 73 68 24 126 43 130 43 3 1 8 -32 11 -71z m-923 -1000 c0 -144 -2 -259 -5 -257 -2 3 -5 104 -6 225 0 122 -5 227 -9 234 -11 19 -29 6 -190 -139 -74 -66 -138 -121 -142 -121 -5 0 61 62 144 139 84 76 162 148 172 160 11 11 23 21 28 21 4 0 8 -118 8 -262z m-120 52 c0 -5 -5 -10 -11 -10 -5 0 -7 5 -4 10 3 6 8 10 11 10 2 0 4 -4 4 -10z m-281 -157 c-65 -55 -83 -64 -29 -15 30 27 57 48 59 46 2 -2 -11 -16 -30 -31z m398 -230 c-2 -16 -4 -5 -4 22 0 28 2 40 4 28 2 -13 2 -35 0 -50z m-107 6 c0 -6 -4 -7 -10 -4 -5 3 -10 11 -10 16 0 6 5 7 10 4 6 -3 10 -11 10 -16z"/>
                <path d="M5022 6770 c0 -14 2 -19 5 -12 2 6 2 18 0 25 -3 6 -5 1 -5 -13z"/>
                <path d="M5022 6720 c0 -14 2 -19 5 -12 2 6 2 18 0 25 -3 6 -5 1 -5 -13z"/>
            </g>
        </svg>
    </div>

    <!-- Main Title & Subtitle -->
    <div id="text-container" class="content-hidden">
        <h1 id="main-title" tabindex="-1">SURFACE TENSION</h1>
        <h2 id="subtitle">a multidimensional experiential brand</h2>
    </div>

    <!-- Top Title (for after audio is enabled) -->
    <div id="top-title-container" class="content-hidden">
        <h1 id="top-title">SURFACE TENSION</h1>
    </div>

    <!-- WebGL Canvas will be injected here by Three.js -->
    <div id="vfx-canvas-container"></div>

    <!-- UI Elements -->
    <div id="ui-container" class="content-hidden">
        <div id="social-links-container">
            <a href="https://www.instagram.com/surfacetension.co" target="_blank" rel="noopener noreferrer" aria-label="Instagram"><svg fill="currentColor" viewBox="0 0 24 24"><path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.85s-.011 3.584-.069 4.85c-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07s-3.584-.012-4.85-.07c-3.252-.148-4.771-1.691-4.919-4.919-.058-1.265-.07-1.645-.07-4.85s.012-3.584.07-4.85c.148-3.225 1.664-4.771 4.919-4.919C8.416 2.175 8.796 2.163 12 2.163zm0 1.802c-3.143 0-3.505.012-4.73.068-2.693.123-3.995 1.424-4.118 4.118-.056 1.225-.068 1.586-.068 4.73s.012 3.505.068 4.73c.123 2.693 1.424 3.995 4.118 4.118 1.225.056 1.586.068 4.73.068s3.505-.012 4.73-.068c2.693-.123 3.995-1.424 4.118-4.118.056-1.225.068-1.586.068-4.73s-.012-3.505-.068-4.73c-.123-2.693-1.424-3.995-4.118-4.118-1.225-.056-1.586-.068-4.73-.068zm0 3.888c-2.402 0-4.35 1.948-4.35 4.35s1.948 4.35 4.35 4.35 4.35-1.948 4.35-4.35-1.948-4.35-4.35-4.35zm0 7.167c-1.553 0-2.817-1.264-2.817-2.817s1.264-2.817 2.817-2.817 2.817 1.264 2.817 2.817-1.264 2.817-2.817 2.817zm4.965-7.332c-.608 0-1.1.492-1.1 1.1s.492 1.1 1.1 1.1 1.1-.492 1.1-1.1-.492-1.1-1.1-1.1z"></path></svg></a>
            <a href="https://www.twitter.com/surfacetensi_n" target="_blank" rel="noopener noreferrer" aria-label="Twitter"><svg fill="currentColor" viewBox="0 0 24 24"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"></path></svg></a>
            <a href="https://www.tiktok.com/@surfacetension.co" target="_blank" rel="noopener noreferrer" aria-label="TikTok"><svg fill="currentColor" viewBox="0 0 24 24"><path d="M19.59 6.69a4.83 4.83 0 0 1-3.77-4.25V2h-3.45v13.67a2.89 2.89 0 0 1-5.2 1.74 2.89 2.89 0 0 1 2.31-4.64 2.93 2.93 0 0 1 .88.13V9.4a6.84 6.84 0 0 0-1-.05A6.33 6.33 0 0 0 5 20.1a6.34 6.34 0 0 0 10.86-4.43v-7a8.16 8.16 0 0 0 4.77 1.52v-3.4a4.85 4.85 0 0 1-1-.1z"/></svg></a>
            <a href="https://www.facebook.com/profile.php?id=61577915426183" target="_blank" rel="noopener noreferrer" aria-label="Facebook"><svg fill="currentColor" viewBox="0 0 24 24"><path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/></svg></a>
        </div>
    </div>

    <!-- Footer Elements -->
    <div id="footer-elements" class="content-hidden">
        <a id="contact-link" href="https://surfacetension.co/qr" target="_blank" rel="noopener noreferrer">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path></svg>
            Connect With Us
        </a>
        <div id="rights-text">All Rights Reserved</div>
    </div>

    <!-- External Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.9.1/gsap.min.js"></script>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const CinematicEngine = {
            scenes: {},
            renderers: [],
            audio: {
                context: null, stream: null, analyser: null, dataArray: null, lastDataArray: null,
                smoothedEnergy: 0, smoothedTone: 0.5, smoothedVocal: 0,
                flux: { bass: 0, mid: 0, high: 0 }, 
                smoothedFlux: { bass: 0, mid: 0, high: 0 },
                energyHistory: new Array(128).fill(0), dropThreshold: 1.4, lastDropTime: 0,
                silenceCounter: 0, silenceThreshold: 150,
            },
            color: {
                currentPalette: {}, lastTone: 0.5, toneChangeThreshold: 0.03,
                lastPaletteChange: 0, paletteChangeInterval: 10000, minPaletteChangeInterval: 4000,
            },

            lerp(start, end, amt) {
                return (1 - amt) * start + amt * end;
            },

            generatePalettesFromTone(tone) {
                const baseHue = 0.6 - (tone * 0.6);
                const complementaryHue = (baseHue + 0.5) % 1.0;
                return {
                    paletteA: {
                        color1: new THREE.Color().setHSL(baseHue, 0.7, 0.1),
                        color2: new THREE.Color().setHSL((baseHue + 0.15) % 1.0, 0.8, 0.45),
                        color3: new THREE.Color().setHSL((baseHue + 0.6) % 1.0, 0.9, 0.65)
                    },
                    paletteB: {
                        color1: new THREE.Color().setHSL(complementaryHue, 0.6, 0.1),
                        color2: new THREE.Color().setHSL((complementaryHue + 0.1) % 1.0, 0.7, 0.5),
                        color3: new THREE.Color().setHSL((complementaryHue + 0.5) % 1.0, 0.8, 0.7)
                    }
                };
            },
            
            setPaletteTargets(mesh, palettes) {
                mesh.material.uniforms.uTargetColor1.value.copy(palettes.paletteA.color1);
                mesh.material.uniforms.uTargetColor2.value.copy(palettes.paletteA.color2);
                mesh.material.uniforms.uTargetColor3.value.copy(palettes.paletteA.color3);
                mesh.material.uniforms.uTargetColor4.value.copy(palettes.paletteB.color1);
                mesh.material.uniforms.uTargetColor5.value.copy(palettes.paletteB.color2);
                mesh.material.uniforms.uTargetColor6.value.copy(palettes.paletteB.color3);
            },

            getSimplexNoiseShader() {
                return `
                    vec3 mod289(vec3 x) { return x - floor(x * (1.0 / 289.0)) * 289.0; }
                    vec4 mod289(vec4 x) { return x - floor(x * (1.0 / 289.0)) * 289.0; }
                    vec4 permute(vec4 x) { return mod289(((x*34.0)+1.0)*x); }
                    vec4 taylorInvSqrt(vec4 r) { return 1.79284291400159 - 0.85373472095314 * r; }
                    float snoise(vec3 v) {
                      const vec2 C = vec2(1.0/6.0, 1.0/3.0); const vec4 D = vec4(0.0, 0.5, 1.0, 2.0);
                      vec3 i = floor(v + dot(v, C.yyy)); vec3 x0 = v - i + dot(i, C.xxx);
                      vec3 g = step(x0.yzx, x0.xyz); vec3 l = 1.0 - g; vec3 i1 = min(g, l.zxy); vec3 i2 = max(g, l.zxy);
                      vec3 x1 = x0 - i1 + C.xxx; vec3 x2 = x0 - i2 + C.yyy; vec3 x3 = x0 - D.yyy;
                      i = mod289(i);
                      vec4 p = permute( permute( permute(i.z + vec4(0.0, i1.z, i2.z, 1.0)) + i.y + vec4(0.0, i1.y, i2.y, 1.0)) + i.x + vec4(0.0, i1.x, i2.x, 1.0));
                      float n_ = 0.142857142857; vec3 ns = n_ * D.wyz - D.xzx;
                      vec4 j = p - 49.0 * floor(p * ns.z * ns.z);
                      vec4 x_ = floor(j * ns.z); vec4 y_ = floor(j - 7.0 * x_);
                      vec4 x = x_ *ns.x + ns.yyyy; vec4 y = y_ *ns.x + ns.yyyy;
                      vec4 h = 1.0 - abs(x) - abs(y); vec4 b0 = vec4(x.xy, y.xy); vec4 b1 = vec4(x.zw, y.zw);
                      vec4 s0 = floor(b0)*2.0 + 1.0; vec4 s1 = floor(b1)*2.0 + 1.0; vec4 sh = -step(h, vec4(0.0));
                      vec4 a0 = b0.xzyw + s0.xzyw*sh.xxyy; vec4 a1 = b1.xzyw + s1.xzyw*sh.zzww;
                      vec3 p0 = vec3(a0.xy,h.x); vec3 p1 = vec3(a0.zw,h.y); vec3 p2 = vec3(a1.xy,h.z); vec3 p3 = vec3(a1.zw,h.w);
                      vec4 norm = taylorInvSqrt(vec4(dot(p0,p0), dot(p1,p1), dot(p2,p2), dot(p3,p3)));
                      p0 *= norm.x; p1 *= norm.y; p2 *= norm.z; p3 *= norm.w;
                      vec4 m = max(0.6 - vec4(dot(x0,x0), dot(x1,x1), dot(x2,x2), dot(x3,x3)), 0.0);
                      m = m * m; return 42.0 * dot( m*m, vec4( dot(p0,x0), dot(p1,x1), dot(p2,x2), dot(p3,x3) ) );
                    }
                `;
            },

            initAudio() {
                const audioButton = document.getElementById('audio-button');
                const uiContainer = document.getElementById('ui-container');
                if (!audioButton) { return; }

                if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                    audioButton.textContent = "Audio API not supported"; return;
                }

                const enableAudio = async () => {
                    try {
                        this.audio.context = new (window.AudioContext || window.webkitAudioContext)();
                        this.audio.stream = await navigator.mediaDevices.getUserMedia({ audio: true, video: false });
                        const source = this.audio.context.createMediaStreamSource(this.audio.stream);
                        this.audio.analyser = this.audio.context.createAnalyser();
                        this.audio.analyser.fftSize = 1024;
                        this.audio.analyser.smoothingTimeConstant = 0.8;
                        source.connect(this.audio.analyser);
                        const bufferLength = this.audio.analyser.frequencyBinCount;
                        this.audio.dataArray = new Uint8Array(bufferLength);
                        this.audio.lastDataArray = new Uint8Array(bufferLength);

                        audioButton.textContent = "Disable Audio";
                        audioButton.classList.add('active');
                        uiContainer.classList.add('audio-active');
                        
                        // Use GSAP to fade out main title and subtitle
                        gsap.to(["#main-title", "#subtitle"], { opacity: 0, duration: 1.5, ease: 'power2.inOut', onComplete: () => {
                            // Fade in top title after the main ones are gone
                            gsap.to("#top-title", { opacity: 1, duration: 1.5, ease: 'power2.inOut', delay: 0.2 });
                        }});
                        setTimeout(() => uiContainer.classList.add('ui-hidden'), 2000);

                    } catch (err) {
                        console.error("Error accessing microphone:", err);
                        audioButton.textContent = "Audio Denied";
                        this.audio.context = null; this.audio.stream = null;
                    }
                };

                const disableAudio = () => {
                    if (this.audio.context && this.audio.context.state !== 'closed') { this.audio.context.close(); }
                    if (this.audio.stream) { this.audio.stream.getTracks().forEach(track => track.stop()); }
                    this.audio.analyser = null; this.audio.context = null; this.audio.stream = null;

                    audioButton.textContent = "Enable Audio";
                    audioButton.classList.remove('active');
                    uiContainer.classList.remove('audio-active');
                    uiContainer.classList.remove('ui-hidden');

                    // Fade out top title, then fade in main title and subtitle
                    gsap.to("#top-title", { opacity: 0, duration: 1.5, ease: 'power2.inOut', onComplete: () => {
                         gsap.to(["#main-title", "#subtitle"], { opacity: 1, duration: 1.5, ease: 'power2.inOut', delay: 0.2 });
                    }});
                };

                audioButton.addEventListener('click', () => {
                    if (this.audio.context && this.audio.context.state !== 'closed') { disableAudio(); } else { enableAudio(); }
                });
            },

            createScene(id, options) {
                const container = document.getElementById(id);
                if (!container) return;

                try {
                    const scene = new THREE.Scene();
                    const camera = new THREE.PerspectiveCamera(60, container.clientWidth / container.clientHeight, 0.1, 1000);
                    camera.position.z = options.cameraZ || 5;

                    const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true, powerPreference: "high-performance" });
                    renderer.setClearColor(0x000000, 0); 
                    renderer.setSize(container.clientWidth, container.clientHeight);
                    renderer.setPixelRatio(Math.min(window.devicePixelRatio, 1.5));
                    container.appendChild(renderer.domElement);
                    this.renderers.push(renderer);
                    
                    const material = new THREE.ShaderMaterial(options.shader);
                    const mesh = new THREE.Mesh(options.geometry, material);
                    scene.add(mesh);

                    const clock = new THREE.Clock();
                    const animate = () => {
                        requestAnimationFrame(animate);
                        const t = clock.getElapsedTime();
                        if (options.update) { options.update({ t, main: mesh }); }
                        renderer.render(scene, camera);
                    };
                    animate();
                    this.scenes[id] = { scene, camera, renderer, mesh };
                } catch (e) {
                    console.error(`Error creating VFX scene "${id}":`, e);
                    throw e;
                }
            },
            
            initCinematicAtmosphere() {
                const geometry = new THREE.PlaneGeometry(20, 12, 1, 1);
                const initialPalettes = this.generatePalettesFromTone(0.5);

                this.createScene('vfx-canvas-container', {
                    cameraZ: 5,
                    geometry: geometry,
                    shader: {
                        uniforms: { 
                            uTime: { value: 0 },
                            uResolution: { value: new THREE.Vector2(window.innerWidth, window.innerHeight) },
                            uAudioEnergy: { value: 0.0 }, uAudioVocal: { value: 0.0 },
                            uDropIntensity: { value: 0.0 }, uTone: { value: 0.5 },
                            uNoiseSeed: { value: Math.random() * 1000 },
                            // Palette A
                            uColor1: { value: initialPalettes.paletteA.color1.clone() },
                            uColor2: { value: initialPalettes.paletteA.color2.clone() },
                            uColor3: { value: initialPalettes.paletteA.color3.clone() },
                            uTargetColor1: { value: initialPalettes.paletteA.color1.clone() },
                            uTargetColor2: { value: initialPalettes.paletteA.color2.clone() },
                            uTargetColor3: { value: initialPalettes.paletteA.color3.clone() },
                            // Palette B
                            uColor4: { value: initialPalettes.paletteB.color1.clone() },
                            uColor5: { value: initialPalettes.paletteB.color2.clone() },
                            uColor6: { value: initialPalettes.paletteB.color3.clone() },
                            uTargetColor4: { value: initialPalettes.paletteB.color1.clone() },
                            uTargetColor5: { value: initialPalettes.paletteB.color2.clone() },
                            uTargetColor6: { value: initialPalettes.paletteB.color3.clone() },
                            
                            uKick: { value: 0.0 },
                        },
                        vertexShader: `varying vec2 vUv; void main() { vUv = uv; gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0); }`,
                        // --- REBUILT FRAGMENT SHADER FOR 3D DEPTH & MULTI-PALETTE MIXING ---
                        fragmentShader: `
                            precision highp float; 
                            ${this.getSimplexNoiseShader()}
                            varying vec2 vUv;
                            uniform float uTime, uAudioEnergy, uAudioVocal, uDropIntensity, uTone, uNoiseSeed;
                            uniform vec3 uColor1, uColor2, uColor3; // Palette A
                            uniform vec3 uColor4, uColor5, uColor6; // Palette B
                            uniform float uKick;

                            mat2 rotate(float a) {
                                float s = sin(a); float c = cos(a);
                                return mat2(c, -s, s, c);
                            }

                            // Function to get a color from a palette based on a noise value
                            vec3 getPaletteColor(float n, vec3 c1, vec3 c2, vec3 c3) {
                                vec3 color = mix(c1, c2, smoothstep(-0.2, 0.2, n));
                                color = mix(color, c3, smoothstep(0.2, 0.4, n));
                                return color;
                            }

                            void main() {
                                // --- 1. VIRTUAL 3D CAMERA & COORDINATES ---
                                // Simulate a slow zoom and pan for depth and non-repetition
                                vec2 baseUv = vUv - 0.5;
                                baseUv *= (1.0 - sin(uTime * 0.02) * 0.05); // Slow zoom
                                baseUv += vec2(uTime * 0.01, uTime * 0.005); // Slow pan
                                
                                // --- 2. MULTI-LAYERED NOISE FOR PALETTE A (BASE LAYER) ---
                                float timeA = uTime * 0.1;
                                vec3 pA1 = vec3(baseUv * 1.2 + uNoiseSeed, timeA);
                                float noiseA1 = snoise(pA1);
                                vec3 pA2 = vec3(baseUv * 2.5 + noiseA1 * 0.2, timeA);
                                float noiseA2 = snoise(pA2);
                                vec3 colorA = getPaletteColor(noiseA2, uColor1, uColor2, uColor3);

                                // --- 3. INDEPENDENT NOISE FOR PALETTE B (INJECTED LAYER) ---
                                // This system uses a different time and seed to look completely different
                                float timeB = uTime * 0.08;
                                vec3 pB1 = vec3(baseUv * 1.0 + uNoiseSeed + 10.0, timeB);
                                float noiseB1 = snoise(pB1);
                                vec3 pB2 = vec3(baseUv * 3.5 + noiseB1 * 0.3, timeB);
                                float noiseB2 = snoise(pB2);
                                vec3 colorB = getPaletteColor(noiseB2, uColor4, uColor5, uColor6);

                                // --- 4. MASKING & BLENDING ---
                                // A third noise system determines where Palette B appears over Palette A.
                                float timeM = uTime * 0.06;
                                float maskNoise = snoise(vec3(baseUv * 0.6 + uNoiseSeed - 20.0, timeM));
                                
                                // Audio reactivity controls the mixing. More energy = sharper, more defined mixing.
                                float mixThreshold = 0.1 - uAudioEnergy * 0.2 - uDropIntensity * 0.3;
                                float mixSharpness = 0.1 + uAudioEnergy * 0.3 + uDropIntensity * 0.5;
                                float mixFactor = smoothstep(mixThreshold, mixThreshold + mixSharpness, maskNoise);
                                
                                vec3 finalColor = mix(colorA, colorB, mixFactor);

                                // --- 5. FINAL POLISH & ACCENTS ---
                                float kickGlow = 1.0 - smoothstep(0.0, 0.6, length(baseUv));
                                finalColor += (uColor3 + uColor6) * 0.5 * uKick * kickGlow * 0.5;

                                float vignette = 1.0 - pow(length(vUv - 0.5) * 1.2, 2.0);
                                float finalIntensity = 0.7 + uAudioEnergy * 0.3;
                                finalColor *= vignette * finalIntensity;
                                
                                finalColor += (snoise(vec3(vUv * 800.0, uTime * 2.0)) * 0.5 + 0.5) * 0.01;

                                gl_FragColor = vec4(finalColor, 1.0);
                            }`
                    },
                    update: ({ t, main }) => {
                        const pNow = performance.now(), uniforms = main.material.uniforms;
                        uniforms.uTime.value = t;

                        if (this.audio.analyser) {
                            this.audio.analyser.getByteFrequencyData(this.audio.dataArray);
                            const bufferLength = this.audio.analyser.frequencyBinCount;
                            let energy=0, vocals=0, spectralCentroid=0, spectralSum=0;
                            const bassBins=Math.floor(bufferLength*0.1), vocalBins=Math.floor(bufferLength*0.4);
                            this.audio.flux = {bass:0};
                            
                            for (let i=0; i<bufferLength; i++) {
                                const currentVal=this.audio.dataArray[i], lastVal=this.audio.lastDataArray[i], flux=Math.max(0, currentVal-lastVal);
                                if(i<bassBins)this.audio.flux.bass+=flux;
                                const val=Math.pow(currentVal/255, 2);
                                energy+=val; if(i>=bassBins&&i<vocalBins)vocals+=val;
                                spectralCentroid+=i*val; spectralSum+=val;
                            }
                            this.audio.lastDataArray.set(this.audio.dataArray);
                            energy=Math.sqrt(energy/bufferLength); if(spectralSum>0)spectralCentroid/=spectralSum;
                            
                            if(energy<0.005)this.audio.silenceCounter++; else this.audio.silenceCounter=0;
                            if(this.audio.silenceCounter>this.audio.silenceThreshold){uniforms.uNoiseSeed.value=Math.random()*1000; this.audio.silenceCounter=0;}
                            
                            this.audio.smoothedEnergy=Math.max(energy, this.audio.smoothedEnergy*0.97);
                            this.audio.smoothedTone=(spectralCentroid/bufferLength)*0.08 + this.audio.smoothedTone*0.92;
                            this.audio.smoothedVocal=Math.max(Math.sqrt(vocals/(vocalBins-bassBins)), this.audio.smoothedVocal*0.95);
                            this.audio.smoothedFlux.bass=Math.max(this.audio.flux.bass/(bassBins*255), this.audio.smoothedFlux.bass*0.92);
                            
                            this.audio.energyHistory.push(this.audio.smoothedEnergy); this.audio.energyHistory.shift();
                            const avgEnergy=this.audio.energyHistory.reduce((a,b)=>a+b,0)/this.audio.energyHistory.length;
                            if(this.audio.smoothedEnergy>avgEnergy*this.audio.dropThreshold&&t>this.audio.lastDropTime+1.5){uniforms.uDropIntensity.value=1.0; this.audio.lastDropTime=t;}
                            
                            if(Math.abs(this.audio.smoothedTone-this.color.lastTone)>this.color.toneChangeThreshold&&(pNow-this.color.lastPaletteChange>this.color.minPaletteChangeInterval)){
                                const newPalettes = this.generatePalettesFromTone(this.audio.smoothedTone);
                                this.setPaletteTargets(main, newPalettes);
                                this.color.lastTone=this.audio.smoothedTone; this.color.lastPaletteChange=pNow;
                            }
                        } else {
                            this.audio.smoothedEnergy*=0.96; this.audio.smoothedVocal*=0.96;
                            this.audio.smoothedFlux.bass*=0.94;
                            if(pNow-this.color.lastPaletteChange > this.color.paletteChangeInterval){
                                const newPalettes = this.generatePalettesFromTone(0.5 + Math.sin(t * 0.05) * 0.5);
                                this.setPaletteTargets(main, newPalettes);
                                this.color.lastPaletteChange=pNow;
                            }
                        }
                        
                        const lerpFactor=0.04, colorLerpFactor=0.02;
                        uniforms.uDropIntensity.value*=0.96;
                        uniforms.uAudioEnergy.value=this.lerp(uniforms.uAudioEnergy.value,this.audio.smoothedEnergy,lerpFactor);
                        uniforms.uAudioVocal.value=this.lerp(uniforms.uAudioVocal.value,this.audio.smoothedVocal,lerpFactor);
                        uniforms.uTone.value=this.lerp(uniforms.uTone.value,this.audio.smoothedTone,lerpFactor);
                        uniforms.uKick.value=this.lerp(uniforms.uKick.value,this.audio.smoothedFlux.bass,lerpFactor*1.5);
                        
                        // Lerp all 6 colors for both palettes
                        uniforms.uColor1.value.lerp(uniforms.uTargetColor1.value,colorLerpFactor);
                        uniforms.uColor2.value.lerp(uniforms.uTargetColor2.value,colorLerpFactor);
                        uniforms.uColor3.value.lerp(uniforms.uTargetColor3.value,colorLerpFactor);
                        uniforms.uColor4.value.lerp(uniforms.uTargetColor4.value,colorLerpFactor);
                        uniforms.uColor5.value.lerp(uniforms.uTargetColor5.value,colorLerpFactor);
                        uniforms.uColor6.value.lerp(uniforms.uTargetColor6.value,colorLerpFactor);
                    }
                });
            },
            
            handleResize() {
                this.renderers.forEach((renderer) => {
                    const container = renderer.domElement.parentElement;
                    if (container && container.clientWidth > 0) {
                        const sceneData = Object.values(this.scenes)[0];
                        if (sceneData && sceneData.camera) {
                            sceneData.camera.aspect = container.clientWidth / container.clientHeight;
                            sceneData.camera.updateProjectionMatrix();
                            if (sceneData.mesh.material.uniforms.uResolution) {
                               sceneData.mesh.material.uniforms.uResolution.value.set(container.clientWidth, container.clientHeight);
                            }
                        }
                        renderer.setSize(container.clientWidth, container.clientHeight);
                    }
                });
            }
        };

        // --- Main Execution ---
        try {
            if (!window.THREE || !window.gsap) {
                throw new Error("Core libraries (Three.js or GSAP) failed to load.");
            }
            CinematicEngine.initAudio();
            CinematicEngine.initCinematicAtmosphere();
            window.addEventListener('resize', () => CinematicEngine.handleResize());

            document.querySelectorAll('.content-hidden').forEach(el => {
                el.classList.add('content-visible');
                el.classList.remove('content-hidden');
            });
            
            const uiContainer = document.getElementById('ui-container');
            let uiHideTimeout;
            const showUi = () => {
                if(uiContainer.classList.contains('ui-hidden')) { uiContainer.classList.remove('ui-hidden'); }
                clearTimeout(uiHideTimeout);
                if (uiContainer.classList.contains('audio-active')) {
                    uiHideTimeout = setTimeout(() => uiContainer.classList.add('ui-hidden'), 2500);
                }
            };
            window.addEventListener('mousemove', showUi);
            window.addEventListener('dblclick', showUi);
            let touchStartTime = 0;
            window.addEventListener('touchstart', () => { touchStartTime = Date.now(); });
            window.addEventListener('touchend', () => { if (Date.now() - touchStartTime > 500) showUi(); });

        } catch (error) {
            // Log full error details to console for debugging
            console.error("A fatal error occurred during page initialization:", error);
            // Display generic error message to user without exposing sensitive details
            const errorContainer = document.getElementById('vfx-canvas-container') || document.body;
            errorContainer.innerHTML = `<div style="padding: 2em; text-align: center; color: white; font-family: monospace; z-index: 1000; position: relative;"><h2 style="color: #ff6b6b;">An Error Occurred</h2><p style="margin-top: 1em;">The animation could not be started. Please check the browser console for details.</p><p style="margin-top: 1.5em; opacity: 0.8; font-size: 0.9em;">If the problem persists, please try refreshing the page or contact support.</p></div>`;
            const uiContainer = document.getElementById('ui-container');
            if (uiContainer) {
                uiContainer.style.display = 'none';
            }
        }
    });
    </script>
</body>
</html>
